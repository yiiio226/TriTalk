# Uncomment this line to define a global platform for your project
platform :ios, '15.0'

# CocoaPods analytics sends network stats synchronously affecting flutter build latency.
ENV['COCOAPODS_DISABLE_STATS'] = 'true'

project 'Runner', {
  'Debug' => :debug,
  'Profile' => :release,
  'Release' => :release,
}

def flutter_root
  generated_xcode_build_settings_path = File.expand_path(File.join('..', 'Flutter', 'Generated.xcconfig'), __FILE__)
  unless File.exist?(generated_xcode_build_settings_path)
    raise "#{generated_xcode_build_settings_path} must exist. If you're running pod install manually, make sure flutter pub get is executed first"
  end

  File.foreach(generated_xcode_build_settings_path) do |line|
    matches = line.match(/FLUTTER_ROOT\=(.*)/)
    return matches[1].strip if matches
  end
  raise "FLUTTER_ROOT not found in #{generated_xcode_build_settings_path}. Try deleting Generated.xcconfig, then run flutter pub get"
end

require File.expand_path(File.join('packages', 'flutter_tools', 'bin', 'podhelper'), flutter_root)

flutter_ios_podfile_setup

target 'Runner' do
  use_frameworks!

  # TriTalk Local Development Patch
  # Force matching native versions to avoid resolving to newer, incompatible internal pods (e.g. FirebaseCoreInternal 11.15.0)
  local_env_path = File.expand_path(File.join(File.dirname(__FILE__), '..', 'assets', 'env', '.env.local'))
  if File.exist?(local_env_path)
    puts "⚠️  [TriTalk] Detected .env.local: Pinning Firebase native pods to 11.2.0..."
    pod 'FirebaseCore', '11.2.0'
    pod 'FirebaseCoreInternal', '11.2.0'
    pod 'FirebaseMessaging', '11.2.0'
    pod 'FirebaseInstallations', '11.2.0'
  end

  flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
  target 'RunnerTests' do
    inherit! :search_paths
  end
end

post_install do |installer|
  installer.pods_project.targets.each do |target|
    flutter_additional_ios_build_settings(target)
    target.build_configurations.each do |config|
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'
    end
  end

  # RevenueCat / Xcode 15.2 Compatibility Fix
  # 这是一个针对 RevenueCat 和 Xcode 15.2 不兼容导致 Swift Concurrency 编译报错的临时修复。
  # 该修复仅在本地开发环境 (`flutter run --dart-define=ENV=local`) 且存在 `.env.local` 时生效。
  # 生产环境构建 (CI/CD) 不受影响，将使用官方 SDK 原样代码。
  # 
  # Check if we are in local development environment by looking for .env.local
  local_env_path = File.expand_path(File.join(File.dirname(__FILE__), '..', 'assets', 'env', '.env.local'))

  if File.exist?(local_env_path)
    puts "⚠️  [TriTalk] Detected .env.local: Applying RevenueCat Concurrency Patch..."
    
    # Workaround for RevenueCat Swift Compiler Error (Main Actor Isolation)
    # This replaces the beginBackgroundTask function to avoid UIApplication calls that violate MainActor isolation.
    events_manager_path = File.join(installer.sandbox.root, 'RevenueCat/Sources/Events/EventsManager.swift')
    if File.exist?(events_manager_path)
      text = File.read(events_manager_path)
      
      patched_marker = "// PATCHED_BY_TRITALK"
      
      unless text.include?(patched_marker)
        puts "Patching RevenueCat EventsManager.swift to fix Swift Concurrency error..."
        
        # Use regex to match the problematic #if block containing beginBackgroundTask
        # This is more robust than exact string matching as it handles whitespace/encoding differences
        pattern = /
          (\#if\s+swift\(\>=5\.9\)\s+&&\s+\(os\(iOS\)\s+\|\|\s+os\(tvOS\)\s+\|\|\s+VISION_OS\)\s*\n)
          (@available\(iOS\s+15\.0,\s+tvOS\s+15\.0,\s+macOS\s+12\.0,\s+watchOS\s+8\.0,\s+\*\)\s*\n)
          (private\s+extension\s+EventsManager\s*\{\s*\n)
          (.*?beginBackgroundTask.*?)
          (\}\s*\n\#endif)
        /mx
        
        replacement = <<~'SWIFT'
// PATCHED_BY_TRITALK: Disabled to fix Swift Concurrency MainActor isolation error
#if swift(>=5.9) && (os(iOS) || os(tvOS) || VISION_OS)
@available(iOS 15.0, tvOS 15.0, macOS 12.0, watchOS 8.0, *)
private extension EventsManager {

    /// Background task disabled to avoid MainActor isolation issues in strict concurrency mode.
    /// This means events may not flush when app goes to background.
    static func beginBackgroundTask(named taskName: String) -> (@Sendable () -> Void)? {
        Logger.debug(EventsManagerStrings.background_task_unavailable)
        return nil
    }

}
#endif
        SWIFT
        
        new_text = text.sub(pattern, replacement.strip)
        
        if new_text != text
          File.write(events_manager_path, new_text)
          puts "✅ Patched RevenueCat EventsManager.swift successfully!"
        else
          puts "⚠️  Pattern not found - RevenueCat SDK may have been updated. Trying alternative patch..."
          
          # Alternative: Direct line-based replacement for the function body
          # Find the static func beginBackgroundTask line and replace the entire function
          if text.include?("static func beginBackgroundTask(named taskName: String)")
            lines = text.lines
            patched_lines = []
            skip_until_closing_brace = false
            brace_depth = 0
            in_target_function = false
            function_replaced = false
            
            lines.each_with_index do |line, index|
              if !function_replaced && line.include?("static func beginBackgroundTask(named taskName: String)")
                in_target_function = true
                brace_depth = 0
                # Add patched function instead
                patched_lines << "    // PATCHED_BY_TRITALK: Disabled to fix Swift Concurrency MainActor isolation error\n"
                patched_lines << "    static func beginBackgroundTask(named taskName: String) -> (@Sendable () -> Void)? {\n"
                patched_lines << "        Logger.debug(EventsManagerStrings.background_task_unavailable)\n"
                patched_lines << "        return nil\n"
                patched_lines << "    }\n"
                skip_until_closing_brace = true
                next
              end
              
              if skip_until_closing_brace
                brace_depth += line.count('{') - line.count('}')
                if line.strip == "}" && brace_depth <= 0
                  skip_until_closing_brace = false
                  in_target_function = false
                  function_replaced = true
                end
                next
              end
              
              patched_lines << line
            end
            
            if function_replaced
              File.write(events_manager_path, patched_lines.join)
              puts "✅ Patched RevenueCat EventsManager.swift using alternative method!"
            else
              puts "❌ Could not patch RevenueCat EventsManager.swift - please report this issue."
            end
          else
            puts "❌ Could not find beginBackgroundTask function in EventsManager.swift"
          end
        end
      else
        puts "✅ RevenueCat EventsManager.swift already patched."
      end
    else
      puts "⚠️  RevenueCat EventsManager.swift not found at expected path."
    end
  else
    puts "✅ [TriTalk] No .env.local detected: Skipping RevenueCat Patch (Production/Clean Build)."
  end
end
