default_platform(:android)

platform :android do
  desc "éƒ¨ç½²åˆ° Google Play å†…éƒ¨æµ‹è¯•"
  lane :deploy_internal do
    # 1. ä» Google Play è·å–æœ€æ–°çš„ version code å¹¶é€’å¢
    # å¦‚æœæ²¡æœ‰è®¾ç½® VERSION_CODE ç¯å¢ƒå˜é‡ï¼Œåˆ™è‡ªåŠ¨è·å–
    version_code = ENV["VERSION_CODE"]
    
    if version_code.nil? || version_code.empty?
      # è·å– internal track ä¸Šçš„æœ€æ–° version codes
      version_codes = google_play_track_version_codes(
        track: 'internal',
        json_key: './pc-api.json'
      )
      
      # å¦‚æœæœ‰ç‰ˆæœ¬ï¼Œå–æœ€å¤§å€¼ +1ï¼›å¦åˆ™ä» 1 å¼€å§‹
      if version_codes.empty?
        version_code = "1"
      else
        version_code = (version_codes.max + 1).to_s
      end
      
      UI.message("è‡ªåŠ¨è®¡ç®— versionCode: #{version_code}")
    end

    # è·å–ç‰ˆæœ¬åç§° (ä»ç¯å¢ƒå˜é‡æˆ– pubspec.yaml)
    version_name = ENV["VERSION_NAME"]
    if version_name.nil? || version_name.empty?
      # ä» pubspec.yaml è¯»å–ç‰ˆæœ¬å· (fastlane è¿è¡Œç›®å½•æ˜¯ android/fastlane)
      pubspec = File.read("../../pubspec.yaml")
      version_match = pubspec.match(/version:\s*(\d+\.\d+\.\d+)/)
      version_name = version_match ? version_match[1] : "1.0.0"
      UI.message("ä» pubspec.yaml è¯»å–ç‰ˆæœ¬å: #{version_name}")
    end

    # 2. æ„å»º AAB (Release æ¨¡å¼)
    UI.message("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
    UI.message("ğŸš€ æ­£åœ¨æ„å»º AAB...")
    UI.message("   Version Name: #{version_name}")
    UI.message("   Version Code: #{version_code}")
    UI.message("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
    
    gradle(
      task: "bundle",
      build_type: "Release",
      properties: {
        "android.injected.version.name" => version_name,
        "android.injected.version.code" => version_code
      }
    )

    # 3. ä¸Šä¼ åˆ° Google Play
    # ä½¿ç”¨ç»å¯¹è·¯å¾„é¿å…ç›¸å¯¹è·¯å¾„è§£æé—®é¢˜
    aab_path = File.expand_path('../../build/app/outputs/bundle/release/app-release.aab', __dir__)
    UI.message("AAB è·¯å¾„: #{aab_path}")
    
    upload_to_play_store(
      track: 'internal',
      aab: aab_path,
      json_key: './pc-api.json',
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
    
    UI.success("âœ… æˆåŠŸä¸Šä¼ ç‰ˆæœ¬ #{version_name} (#{version_code}) åˆ° Internal Testing")
  end
end
