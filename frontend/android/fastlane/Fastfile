default_platform(:android)

platform :android do
  desc "éƒ¨ç½²åˆ° Google Play å†…éƒ¨æµ‹è¯•"
  lane :deploy_internal do
    # 1. ä» Google Play è·å–æœ€æ–°çš„ version code å¹¶é€’å¢
    version_code = ENV["VERSION_CODE"]
    
    if version_code.nil? || version_code.empty?
      # è·å– internal track ä¸Šçš„æœ€æ–° version codes
      version_codes = google_play_track_version_codes(
        track: 'internal',
        json_key: './pc-api.json'
      )
      
      # å¦‚æœæœ‰ç‰ˆæœ¬ï¼Œå–æœ€å¤§å€¼ +1ï¼›å¦åˆ™ä» 1 å¼€å§‹
      if version_codes.empty?
        version_code = "1"
      else
        version_code = (version_codes.max + 1).to_s
      end
      
      UI.message("è‡ªåŠ¨è®¡ç®— versionCode: #{version_code}")
    end

    # 2. è¯»å–å¹¶æ›´æ–° pubspec.yaml ä¸­çš„ç‰ˆæœ¬
    pubspec_path = File.expand_path("../../pubspec.yaml", __dir__)
    pubspec_content = File.read(pubspec_path)
    
    # æå–ç‰ˆæœ¬åç§°
    version_match = pubspec_content.match(/version:\s*(\d+\.\d+\.\d+)(?:\+\d+)?/)
    version_name = version_match ? version_match[1] : "1.0.0"
    
    # æ›´æ–° pubspec.yaml ä¸­çš„ç‰ˆæœ¬å· (version_name+version_code æ ¼å¼)
    new_version = "#{version_name}+#{version_code}"
    updated_pubspec = pubspec_content.gsub(/version:\s*\d+\.\d+\.\d+(?:\+\d+)?/, "version: #{new_version}")
    File.write(pubspec_path, updated_pubspec)
    UI.message("å·²æ›´æ–° pubspec.yaml ç‰ˆæœ¬ä¸º: #{new_version}")

    # 3. ä½¿ç”¨ Flutter æ„å»º AAB (Release æ¨¡å¼)
    UI.message("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
    UI.message("ğŸš€ æ­£åœ¨ä½¿ç”¨ Flutter æ„å»º AAB...")
    UI.message("   Version Name: #{version_name}")
    UI.message("   Version Code: #{version_code}")
    UI.message("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
    
    # Flutter é¡¹ç›®éœ€è¦ä½¿ç”¨ flutter build å‘½ä»¤ï¼Œè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨ gradle
    # è¿™æ ·æ‰èƒ½æ­£ç¡®ç¼–è¯‘ Dart ä»£ç å¹¶ä½¿ç”¨ pubspec.yaml ä¸­çš„ç‰ˆæœ¬
    Dir.chdir(File.expand_path("../..", __dir__)) do
      sh("flutter build appbundle --release --dart-define=ENV=prod --obfuscate --split-debug-info=build/debug-info/global")
    end

    # 4. ä¸Šä¼ åˆ° Google Play
    # ä½¿ç”¨ç»å¯¹è·¯å¾„é¿å…ç›¸å¯¹è·¯å¾„è§£æé—®é¢˜
    aab_path = File.expand_path('../../build/app/outputs/bundle/release/app-release.aab', __dir__)
    UI.message("AAB è·¯å¾„: #{aab_path}")
    
    upload_to_play_store(
      track: 'internal',
      aab: aab_path,
      json_key: './pc-api.json',
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
    
    UI.success("âœ… æˆåŠŸä¸Šä¼ ç‰ˆæœ¬ #{version_name} (#{version_code}) åˆ° Internal Testing")
  end
end
