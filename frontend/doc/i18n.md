这是一份根据你的要求，由高级架构师视角整理的 **Flutter 国际化 (i18n) 开发集成规范文档**。

---

# Flutter 国际化 (i18n) 集成指南

## 1. 核心机制

本项目采用 Flutter 官方推荐的 **ARB (Application Resource Bundle)** 格式管理资源。通过 `gen_l10n` 工具将资源文件自动转译为类型安全的 Dart 代码。

- **核心工具**: `flutter_localizations` + `intl`
- **代码生成**: `gen_l10n` (由 Flutter 工具链自动触发)
- **真理源 (Source of Truth)**: `lib/l10n/intl_en.arb`

## 2. 项目配置

### 2.1 依赖配置 (`pubspec.yaml`)

```yaml
dependencies:
  flutter:
    sdk: flutter
  flutter_localizations:
    sdk: flutter
  intl: any

flutter:
  generate: true # 开启自动代码生成
```

### 2.2 生成规则配置 (`l10n.yaml`)

在根目录创建该文件，确保 `nullable-getter: false` 以简化代码调用。

```yaml
arb-dir: lib/l10n
template-arb-file: intl_en.arb # 以英文作为开发基准
output-localization-file: app_localizations.dart
untranslated-messages-file: lib/l10n/untranslated.txt
nullable-getter: false # 避免调用时频繁使用 !
```

## 3. 开发工作流

### 3.1 定义文案 (英文先行)

开发者在 `lib/l10n/intl_en.arb` 中添加 Key 和描述。

```json
{
  "@@locale": "en",
  "loginButton": "Log In",
  "@loginButton": {
    "description": "Text displayed on the login submission button"
  }
}
```

### 3.2 自动化翻译 (LLM 驱动)

由于没有专门翻译团队，我们利用 LLM 处理 `intl_zh.arb` 等其他语言文件。

- **Prompt 策略**: 将 `intl_en.arb` 的内容发送给 LLM，要求其保持 JSON 结构及 Key 不变，仅翻译 Value。
- **检测缺失**: 编译后查看 `lib/l10n/untranslated.txt`，将该文件中的缺失 Key 喂给 LLM 进行补全。

### 3.3 语法糖扩展

为了简化 `AppLocalizations.of(context)` 的冗长调用，项目内置了 `extension`。

**代码片段：`lib/utils/l10n_ext.dart**`

```dart
import 'package:flutter/widgets.dart';
import 'package:flutter_gen/gen_l10n/app_localizations.dart';

extension LocalizedContext on BuildContext {
  /// 快速获取多语言资源: context.l10n.yourKey
  AppLocalizations get l10n => AppLocalizations.of(this);
}

```

## 4. 状态管理与语言切换

使用简单的 `ChangeNotifier` 结合 `Provider` (或类似方案) 实现全局语言切换。

**代码实现：`lib/provider/locale_provider.dart**`

```dart
import 'package:flutter/material.dart';

class LocaleProvider extends ChangeNotifier {
  Locale? _locale;

  Locale? get locale => _locale;

  void setLocale(Locale locale) {
    if (_locale == locale) return;
    _locale = locale;
    notifyListeners(); // 触发全屏刷新
  }

  void clearLocale() {
    _locale = null; // 跟随系统语言
    notifyListeners();
  }
}

```

**入口配置：`main.dart**`

```dart
MaterialApp(
  locale: context.watch<LocaleProvider>().locale,
  localizationsDelegates: AppLocalizations.localizationsDelegates,
  supportedLocales: AppLocalizations.supportedLocales,
  // ...
)

```

## 5. 常见坑点与排查 (Tips & Tricks)

### 5.1 Key 的命名规范

- **坑点**: ARB 文件中的 Key 会直接映射为 Dart 成员变量名。
- **规范**: 必须使用 **小驼峰 (lowerCamelCase)**。禁止使用横杠 `-`、空格或数字开头，否则会导致生成的 Dart 代码编译报错。
- **正确示例**: `"homePageTitle"`
- **错误示例**: `"home-page-title"` 或 `"首页标题"`

### 5.2 IDE 索引未刷新

- **症状**: 修改了 ARB 文件并保存，但代码中 `context.l10n.xxx` 依然提示找不到 Key。
- **解决方案**:

1. 手动运行强制生成命令：

```bash
flutter gen-l10n

```

2. 若还未解决，执行 `flutter clean` 后重新编译。
3. 确保 `lib/l10n/app_localizations.dart` 的引用路径正确（通常指向 `.dart_tool/flutter_gen`）。

### 5.3 占位符类型匹配

- **坑点**: 在 ARB 中定义了 `{count}` 但未指定类型，默认会被处理为 `Object`。
- **规范**: 对于数字、日期等，应明确指定类型，以便在代码中获得正确的参数提醒。

```json
"itemsCount": "You have {count} items",
"@itemsCount": {
  "placeholders": {
    "count": { "type": "int" }
  }
}

```

### 5.4 LLM 翻译注意事项

- **坑点**: LLM 有时会翻译 `@@locale` 字段或修改占位符格式（如将 `{name}` 改为 `[name]`）。
- **规范**: 需在 Prompt 中明确要求：**“严禁修改 JSON 中的 Key 和 `{}` 包裹的占位符，仅翻译内容。”**
