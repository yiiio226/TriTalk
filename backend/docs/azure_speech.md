# 语音发音与口语流利度反馈设计 (Pronunciation & Fluency Feedback Design)

针对语音发音（Pronunciation）和口语流利度（Fluency）的反馈设计，必须要超越简单的“识别准确率”。基于语言学和目前的 AI 能力，一套优秀的口语反馈系统应该包含三个维度：**音素级准确度（Pronunciation）**、**韵律与语调（Prosody/Intonation）** 以及 **流利度（Fluency）**。

以下是为您设计的 **“AI 语音教练模块”** 详细功能设计文档。

## 功能模块详解：AI 智能语音分析 (Smart Speech Analysis)

### 1. 核心设计理念

- 用户不仅想知道“我对了吗？”，还想知道“我哪里读得不像本地人？”。
- 核心体验逻辑是：**可视化（Visualization）** + **对比（Comparison）** + **颗粒度（Granularity）**。

### 2. 功能细节拆解

#### A. 实时反馈层 (Instant Feedback - The "Traffic Light")

- **场景**：用户刚发完语音消息，气泡上屏时。
- **目标**：一眼看出整体好坏，不打断对话流。
- **整体评分环**：在用户语音气泡旁显示一个小圆环分数（如：85 分）。
- **逐词颜色标记 (Color-Coded Text)**：
  - 将用户的语音转写为文字显示在气泡下。
  - 🟢 **绿色**：发音完美。
  - 🟡 **黄色**：发音模糊或重音错误。
  - 🔴 **红色**：发音错误或严重吞音。
  - 🔘 **灰色**：漏读单词。

#### B. 深度诊断层 (Deep Dive - The "Correction Card")

- **场景**：用户点击那条“带颜色的语音气泡”后，底部弹出详细诊断卡片。

### 3. 音素级纠错 (Phoneme Level Error)

这是最硬核的功能，指出具体的发音部位错误。

- **错误定位**：如果用户把 "Think" 读成了 "Sink"。
- **UI 展示**：
  - 高亮单词 **Think**。
  - **音标对比**：你读的是 `/s/` (Sink)，正确是 `/θ/` (Think)。
  - **舌位图解/动图**：展示舌头应该咬在上下齿之间，而不是藏在牙齿后面。
  - (此处可调用舌位图)

### 4. 语调与重音 (Intonation & Stress)

很多用户单词读对了，但听起来像机器人，是因为没有语调。

- **音高曲线 (Pitch Contour)**：
  - 画出一条线，展示 AI (标准音) 的声调起伏（如：疑问句末尾上扬）。
  - 叠加用户录音的声调线。
  - **视觉反馈**：通过两条线的重合度，让用户看到自己是不是“平调”或“降调”了。
- **重音标记 (Stress Markers)**：
  - 在句子中被重读的单词上方打一个着重号 `·`。
  - 例如：I _didn't_ say that. (强调没说，而不是没做)。

### 5. 流利度分析 (Fluency Metrics)

- **WPM (Words Per Minute)**：显示用户的语速 vs 本地人平均语速。
- **停顿检测 (Pause Detection)**：
  - 在句子中不该停顿的地方（如词组中间）标记断裂图标 `//`。
  - 识别并标记口癖（Fillers），如 "um", "uh", "like"。

#### C. 练习与修正 (Practice Loop)

- **目标**：形成闭环，让用户改错。
- **影子跟读 (Shadowing Mode)**：
  - **听标准音**：播放 AI 的完美发音。
  - **听原音**：播放用户刚才的录音（羞耻感是进步的动力）。
  - **合成对比**：即时把两个声音拼在一起播放（左耳用户，右耳 AI），让差距无处遁形。
  - **再次尝试**：提供一个“重录”按钮，只针对这一句话进行 Loop 练习，直到变绿。

## 6. UI 交互线框描述

当用户点击一条评分为 "60 分" 的语音消息时，弹出的 Action Sheet 布局如下：

```text
+-------------------------------------------------------+
|        [Score: 60] Needs Work   [Retry Button 🎤]    |
+-------------------------------------------------------+
|  Sentence:                                            |
|  I [want] to [live] in a [hotel].                     |
|    (黄)      (红)       (绿)                          |
+-------------------------------------------------------+
| 🔴 Error Focus: "live"                                |
| ---------------------------------------------------   |
| 👂 You said: /liːv/ (leave)    [Play User Audio]     |
| 🤖 Correct:  /lɪv/ (live)      [Play AI Audio]       |
|                                                       |
| 💡 Tip: /ɪ/ 是短元音，嘴巴放松，不要拉长。            |
+-------------------------------------------------------+
| 🌊 Intonation (语调):                                 |
| [ 图表：显示一条波浪线，并在末尾标示出你没有升调 ]    |
+-------------------------------------------------------+
```

### 线框图可行性分析 (Wireframe Feasibility)

基于 Azure API 返回的数据，以下是线框图中各元素的实现可行性：

```text
+-------------------------------------------------------+
|  ✅ [Score: 60]        ✅ Needs Work    ✅ [Retry 🎤] |
+-------------------------------------------------------+
|  Sentence:                                            |
|  ✅ I [want] to [live] in a [hotel].                  |
|       (黄)      (红)       (绿)                       |
+-------------------------------------------------------+
| ✅ 🔴 Error Focus: "live"                             |
| ---------------------------------------------------   |
| ❌ 👂 You said: /liːv/ (leave)   ✅ [Play User Audio] |
| ✅ 🤖 Correct:  /lɪv/ (live)     ✅ [Play AI Audio]   |
|                                                       |
| 🔶 💡 Tip: /ɪ/ 是短元音，嘴巴放松，不要拉长。         |
+-------------------------------------------------------+
| ❌ 🌊 Intonation (语调):                              |
| ❌ [ 图表：显示一条波浪线，并在末尾标示出你没有升调 ] |
+-------------------------------------------------------+
```

### 详细分析

| 元素                     | 状态              | 原因 / 数据来源                                        |
| ------------------------ | ----------------- | ------------------------------------------------------ |
| **[Score: 60]**          | ✅ 可实现         | `PronScore: 73.5`                                      |
| **Needs Work**           | ✅ 可实现         | 基于分数阈值判断 (如 <70 = Needs Work)                 |
| **[Retry Button 🎤]**    | ✅ 可实现         | 前端 UI 功能                                           |
| **句子逐词着色**         | ✅ 可实现         | `Words[].AccuracyScore` + `ErrorType`                  |
| **Error Focus: "live"**  | ✅ 可实现         | 筛选 `ErrorType: "Mispronunciation"` 的单词            |
| **👂 You said: /liːv/**  | ❌ **无法实现**   | Azure **不返回用户实际发了什么音**，只返回匹配程度分数 |
| **(leave) 推断错误发音** | ❌ **无法实现**   | 同上，无法知道用户发的是 leave 还是其他                |
| **🤖 Correct: /lɪv/**    | ✅ 可实现         | `Phonemes[].Phoneme` 返回 IPA 音标                     |
| **[Play User Audio]**    | ✅ 可实现         | 前端已保存录音文件                                     |
| **[Play AI Audio]**      | ✅ 可实现         | 使用 TTS 生成标准发音                                  |
| **💡 Tip 发音提示**      | 🔶 **部分可实现** | 需 LLM 或预设内容库，Azure 不提供教学内容              |
| **🌊 语调波浪线图**      | ❌ **无法实现**   | Azure REST API 不返回音高 (pitch) 数据点               |
| **没有升调标记**         | 🔶 **部分可实现** | 只能显示 "Monotone" 错误，无法画曲线                   |

## 7. Azure API 功能可行性分析 (Feature Feasibility Analysis)

基于 Azure Speech Pronunciation Assessment API 返回的实际数据，以下是各功能的实现可行性分析：

### A. 实时反馈层 (Instant Feedback)

| 功能                                  | 状态   | 原因                                                     |
| ------------------------------------- | ------ | -------------------------------------------------------- |
| ✅ **整体评分环 (Overall Score)**     | 可实现 | Azure 返回 `PronScore: 73.5` 作为综合发音评分            |
| ✅ **逐词颜色标记 - 绿色 (发音完美)** | 可实现 | 每个单词有 `AccuracyScore`，可用阈值判断 (如 ≥80 为绿色) |
| ✅ **逐词颜色标记 - 黄色 (发音模糊)** | 可实现 | 可用分数阈值判断 (如 60-79 为黄色)                       |
| ✅ **逐词颜色标记 - 红色 (发音错误)** | 可实现 | `ErrorType: "Mispronunciation"` 或分数 <60 标记为红色    |
| ✅ **逐词颜色标记 - 灰色 (漏读单词)** | 可实现 | `ErrorType: "Omission"` 表示漏读 (需开启 EnableMiscue)   |

### B. 音素级纠错 (Phoneme Level Error)

| 功能                            | 状态        | 原因                                                                         |
| ------------------------------- | ----------- | ---------------------------------------------------------------------------- |
| ✅ **高亮错误单词**             | 可实现      | `ErrorType: "Mispronunciation"` 可精确定位错误单词                           |
| ✅ **音素级准确度分数**         | 可实现      | 每个音素有独立的 `AccuracyScore`，如 `{"Phoneme": "m", "AccuracyScore": 24}` |
| ✅ **显示 IPA 音标**            | 可实现      | Azure 返回 IPA 音标，如 `"Phoneme": "ɔɹ"`, `"ɛ"`, `"ŋ"` 等                   |
| ❌ **对比用户发音 vs 正确发音** | 需 LLM 辅助 | Azure 只返回分数，不返回"用户实际发了什么音"，需要 LLM 根据低分音素推断      |
| ❌ **舌位图解/动图**            | 需额外资源  | Azure 不提供此功能，需自建音素到舌位图的映射库                               |
| 🔶 **发音纠错提示 (Tips)**      | 部分可实现  | 可基于低分音素生成提示，但具体教学内容需预设或 LLM 生成                      |

### C. 语调与重音 (Intonation & Stress)

| 功能                             | 状态       | 原因                                                                  |
| -------------------------------- | ---------- | --------------------------------------------------------------------- |
| ✅ **语调问题检测 (Monotone)**   | 可实现     | Azure 返回 `Intonation.ErrorTypes: ["Monotone"]` 表示语调平淡         |
| ✅ **Prosody 综合评分**          | 可实现     | Azure 返回 `ProsodyScore: 57.8`                                       |
| ❌ **音高曲线 (Pitch Contour)**  | 不可实现   | Azure REST API 不返回音高数据点，无法绘制曲线                         |
| ❌ **用户 vs AI 语调对比曲线**   | 不可实现   | 需要原始音频的音高数据，Azure 不提供                                  |
| 🔶 **重音标记 (Stress Markers)** | 部分可实现 | Azure 返回 `Syllables` 数据，但没有明确的重音标记；可通过音节时长推断 |

### D. 流利度分析 (Fluency Metrics)

| 功能                                    | 状态     | 原因                                                                 |
| --------------------------------------- | -------- | -------------------------------------------------------------------- |
| ✅ **流利度评分 (Fluency Score)**       | 可实现   | Azure 返回 `FluencyScore: 84`                                        |
| ✅ **完整度评分 (Completeness)**        | 可实现   | Azure 返回 `CompletenessScore: 87`，表示参考文本的覆盖程度           |
| ✅ **停顿检测 (Pause Detection)**       | 可实现   | Azure 返回 `Break.BreakLength: 5400000` (单位: 100ns = 0.54 秒停顿)  |
| ✅ **意外停顿 (Unexpected Break)**      | 可实现   | `UnexpectedBreak.Confidence: 1.29` 表示不应该停顿的地方停顿了        |
| ✅ **缺失停顿 (Missing Break)**         | 可实现   | `MissingBreak.Confidence: 1` 表示应该停顿的地方没停                  |
| 🔶 **WPM (Words Per Minute)**           | 可计算   | 使用 `Duration` (总时长) 和单词数量计算：`Words / (Duration / 60秒)` |
| ❌ **口癖检测 (Fillers: um, uh, like)** | 不可实现 | Azure 只匹配参考文本，不检测额外的填充词                             |

### E. 练习与修正 (Practice Loop)

| 功能                         | 状态   | 原因                               |
| ---------------------------- | ------ | ---------------------------------- |
| ✅ **播放用户录音**          | 可实现 | 前端已保存用户录音文件             |
| ✅ **播放 AI 标准音**        | 可实现 | 可使用 TTS 生成参考文本的标准发音  |
| ✅ **重录按钮**              | 可实现 | 前端 UI 功能，不依赖 Azure         |
| 🔶 **合成对比 (左右耳对比)** | 可实现 | 需前端音频合成，技术上可行但较复杂 |

---

## 8. 数据结构速查 (Azure Response Data Reference)

### 整体评分 (NBest[0])

```json
{
  "AccuracyScore": 81, // 准确度
  "FluencyScore": 84, // 流利度
  "ProsodyScore": 57.8, // 韵律/语调
  "CompletenessScore": 87, // 完整度
  "PronScore": 73.5 // 综合发音分数
}
```

### 单词级数据 (Words[])

```json
{
  "Word": "morning",
  "AccuracyScore": 54,
  "ErrorType": "Mispronunciation",  // None | Mispronunciation | Omission | Insertion
  "Syllables": [...],
  "Phonemes": [...],
  "Feedback": {
    "Prosody": {
      "Break": { "BreakLength": 5400000, "UnexpectedBreak": {...} },
      "Intonation": { "ErrorTypes": ["Monotone"] }
    }
  }
}
```

### 音素级数据 (Phonemes[])

```json
{
  "Phoneme": "ɔɹ", // IPA 音标
  "Offset": 18900000, // 开始时间 (100ns)
  "Duration": 2900000, // 持续时间 (100ns)
  "AccuracyScore": 46 // 该音素准确度
}
```

---

## 9. 实现优先级建议 (Implementation Priority)

### Phase 1 - 核心功能 (全部可实现)

1. ✅ 整体评分环显示
2. ✅ 逐词颜色标记 (Traffic Light)
3. ✅ 音素级分数显示
4. ✅ 停顿检测标记

### Phase 2 - 增强功能 (需额外工作)

1. 🔶 发音纠错提示 (需 LLM 或预设内容库)
2. 🔶 WPM 计算与显示
3. 🔶 重音推断 (基于音节时长)

### Phase 3 - 高级功能 (需要额外技术)

1. ❌ 音高曲线对比 (需其他库如 Praat 或 Web Audio API)
2. ❌ 舌位动图 (需自建资源库)
3. ❌ 口癖检测 (可能需要自定义语音识别)

---

## 10. 官方文档

- **发音评估 API 使用指南**: [How to use pronunciation assessment - Azure AI Speech](https://learn.microsoft.com/en-us/azure/ai-services/speech-service/how-to-pronunciation-assessment?pivots=programming-language-javascript)

---

## 💰 成本估算

### Azure 语音转文本 + 发音评估定价

> 💡 **计费说明**：
>
> 发音评估功能提供基线语音转文本价格中不包括的其他分数，例如韵律分数 (Prosody Score)。这些分数是基线语音转文本价格之上的附加费用。
>
> - **计费方式**: 按秒计费
> - **实时听录**: **$1 / 小时** (约 $0.0167 / 分钟)

### 发音评估成本估算

以下按**跟读/发音练习场景**估算：

| 场景                       | 假设参数                          | 计算过程                      | 成本                     |
| -------------------------- | --------------------------------- | ----------------------------- | ------------------------ |
| 单次句子评估 (约 10 词)    | 语速 ~150 wpm → 约 **4 秒**       | 4s × ($1/3600s) = **$0.0011** | **$0.001**               |
| 用户每天 50 句 (深度练习)  | 50 句 × 4 秒 = 200 秒 (~3.3 分钟) | 3.3min × $0.0167/min          | **$0.055 / 天**          |
| **1000 DAU / 月 (无缓存)** | 1000 人 × 30 天                   | 1000 × 30 × $0.055            | **$1,650/月 (≈¥11,880)** |

> 📊 **对比分析**：
>
> Azure 发音评估的成本与 GCP Gemini TTS 相近（均在 $1,500-1,700/月 @ 1000 DAU），但提供了更专业的发音诊断能力（音素级评分、韵律分析、流利度检测等）。
>
> 💡 **优化建议**：发音评估结果可缓存复用（相同文本 + 相同用户录音 = 相同结果），减少重复调用。
